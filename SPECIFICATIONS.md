# カードハンター 仕様書

## 1. システム要件
- 開発環境: TypeScript + React + Vite
- 動作環境: モダンブラウザ（Chrome, Firefox, Safari, Edge）
- 必要なNode.jsバージョン: 16.0.0以上

## 2. データ構造

### 2.1 カード
```typescript
interface Card {
  suit: 'hearts' | 'diamonds' | 'clubs' | 'spades';
  number: number;
  isRevealed: boolean;
}
```

### 2.2 プレイヤー
```typescript
interface Player {
  id: number;
  name: string;
  isComputer: boolean;
  cards: Card[];
  personalityType?: 'aggressive' | 'cautious' | 'balanced';
  skillLevel?: 'beginner' | 'intermediate' | 'expert';
}
```

### 2.3 ゲーム状態
```typescript
interface GameState {
  players: Player[];
  currentPlayerIndex: number;
  gameStatus: 'waiting' | 'playing' | 'finished';
  winner: Player | null;
  logs: GameLog[];
  eliminationOrder: number[];
}
```

### 2.4 ゲームログ
```typescript
interface GameLog {
  guessingPlayer: string;
  targetPlayer: string;
  cardIndex: number;
  guessedSuit: string;
  guessedNumber: number;
  isCorrect: boolean;
  timestamp: number;
}
```

## 3. ゲームロジック詳細

### 3.1 ゲームの基本ルール
1. 4人のプレイヤーでプレイ（1人のプレイヤーと3人のコンピューター）
2. 各プレイヤーは13枚のカードを持ち、数字順に並べられる
3. 順番に他のプレイヤーのカードを予想
4. 予想が当たれば相手のカードが表になり、続けて予想可能
5. 予想が外れれば自分のカードを1枚表にし、次のプレイヤーへ
6. 最後まで裏向きのカードを持っているプレイヤーが勝利

### 3.2 コンピューターAIの実装詳細

> 💡 コンピューターAIの詳細な実装仕様については [AI_SPECIFICATIONS.md](./AI_SPECIFICATIONS.md) を参照してください。

#### 3.2.1 予想ロジック（Strategic Guessing System）の概要
1. **情報収集フェーズ**
   - 既に公開されているカードの把握
   - 過去の不正解の予想から「ありえないカード」を特定
   - 過去の正解パターンの分析とスート傾向の把握

2. **確率計算システム**
   - カードの位置による制約
     - カードが昇順に並んでいることを利用
     - 位置に基づく可能な数字範囲の計算
   - 前後のカードによる制約
     - 公開済みの前後のカードから数字の範囲を制限
     - 範囲内の数字により高い確率を付与
   - スート分布の考慮
     - 同じスートの残り枚数による確率調整
     - 過去の正解パターンからスートの傾向を反映
   - 数字の分布
     - 同じ数字の残り枚数による確率調整
     - 位置に基づく数字の出現確率の計算

3. **難易度レベルによる違い**
   - 初級（Beginner）
     - 基本精度: 30%
     - 予想選択: 確率上位50%からランダム
     - 特徴: 予測精度が低く、よりランダムな選択
   
   - 中級（Intermediate）
     - 基本精度: 60%
     - 予想選択: 確率上位30%からランダム
     - 特徴: バランスの取れた予測とランダム性
   
   - 上級（Expert）
     - 基本精度: 90%
     - 予想選択: 確率上位10%からランダム
     - 特徴: 高い予測精度と戦略的な選択

4. **性格タイプによる行動調整**
   - Aggressive（積極的）
     - 続行判断の基本確率を20%増加
     - リスクを取る傾向が強い
   
   - Cautious（慎重）
     - 続行判断の基本確率を20%減少
     - より安全な選択を好む
   
   - Balanced（バランス型）
     - 基本確率をそのまま使用
     - 状況に応じて柔軟に対応

5. **続行判断システム**
   - スキルレベルに基づく基本確率の設定
   - 性格タイプによる確率の調整
   - 残りカード枚数による状況判断
     - 相手の残りカードが3枚以下: 続行確率20%増加
     - 自分の残りカードが3枚以下: 続行確率20%増加
     - 自分の残りカードが多い: 続行確率20%減少

### 3.3 ゲーム進行の実装

1. **ゲーム開始時**
   - プレイヤー名の入力
   - コンピューターの難易度設定
   - カードの配布とシャッフル（Fisher-Yatesアルゴリズム）
   - カードの昇順ソート

2. **ターン進行**
   - 現在のプレイヤーの判定
   - 予想対象プレイヤーの選択
   - カード予想処理
   - 結果判定と状態更新
   - 次のプレイヤーの決定

3. **ゲーム終了判定**
   - 全カード公開プレイヤーの確認
   - 勝者の決定
   - 順位の計算と記録

4. **ゲームログ管理**
   - 各予想の詳細記録
   - プレイヤーの統計情報の計算
   - 履歴の表示と更新

## 4. 実装状況

### 4.1 実装済み機能
#### コアロジック
- [x] カードの生成と配布
- [x] Fisher-Yatesシャッフルアルゴリズム
- [x] ターン管理システム
- [x] 勝利条件の判定
- [x] ゲームログの記録

#### UI/UX
- [x] プレイヤー入力フォーム
- [x] カード表示コンポーネント
- [x] ゲーム履歴表示
- [x] ダイアログシステム
- [x] レスポンシブレイアウト

#### AI
- [x] コンピュータープレイヤーの基本ロジック
- [x] 戦略的予想アルゴリズム
  - [x] カードの位置による制約の考慮
  - [x] 前後のカードの数字を考慮した予想
  - [x] 確率ベースの予測システム
  - [x] 既存の公開カード情報の活用
- [x] カード公開ロジック

### 4.2 実装予定の機能
#### コアロジック
- [ ] プレイヤー数のカスタマイズ
- [ ] ゲーム設定の保存
- [ ] 統計データの記録

#### UI/UX
- [ ] アニメーション効果
- [ ] サウンドシステム
- [ ] ダークモード
- [ ] モバイル最適化

#### AI
- [ ] 難易度設定
- [ ] 学習型AI（オプション）
- [ ] プレイヤーの行動パターン分析

## 5. コンポーネント構成

### 5.1 メインコンポーネント
- App.tsx: アプリケーションのルートコンポーネント
- GameBoard.tsx: ゲームボード全体の管理
- PlayerSection.tsx: 各プレイヤーの表示領域
- Card.tsx: カードの表示コンポーネント

### 5.2 ユーティリティ
- cardUtils.ts: カード関連のユーティリティ関数
- gameUtils.ts: ゲームロジック関連の関数
- types.ts: 型定義ファイル

## 6. 状態管理
- ローカルステート: React useState
- 永続化: LocalStorage（予定）

## 7. パフォーマンス最適化
- メモ化によるレンダリング最適化
- 非同期処理の適切な管理
- アニメーションの最適化

## 8. セキュリティ考慮事項
- XSS対策
- 入力値のバリデーション
- エラーハンドリング

## 9. テスト計画
- ユニットテスト（Jest）
- コンポーネントテスト（React Testing Library）
- E2Eテスト（Cypress）

## 10. 今後の技術的な課題
1. パフォーマンス最適化
2. モバイル対応の改善
3. アクセシビリティ対応
4. ブラウザ互換性の確保

## 11. 開発環境のセットアップ
```bash
# 必要な依存関係
npm install react react-dom typescript vite @types/react @types/react-dom

# 開発用コマンド
npm run dev    # 開発サーバー起動
npm run build  # プロダクションビルド
npm run test   # テスト実行
```

## UI コンポーネント

### ゲームボード
- プレイヤーセクションの表示
  - プレイヤー名
  - 現在のプレイヤーの表示
  - カードの表示（13枚）
  - 予想対象プレイヤーの表示

### カード選択ダイアログ
- ドラッグ可能なヘッダー付きダイアログ
- スート選択
  - ♥, ♦, ♣, ♠ の記号表示
  - 赤/黒の色分け
- 数字選択（A-K）
- キャンセル・戻るボタン

### ゲーム履歴
- 連番付きエントリー
- プレイヤー名の強調表示
- カードシンボルの視覚的表示
- 2行レイアウト
  - 1行目: プレイヤー情報
  - 2行目: カード予想と結果
- 結果表示（○/×）

## ゲームロジック

### ゲーム開始
1. プレイヤー名の入力
2. 4人のプレイヤー設定（1人のユーザーと3人のコンピュータ）
3. カードの配布（各プレイヤーに13枚）

### ターンの進行
1. プレイヤーの選択
   - 人間プレイヤー: 任意のカードを選択
   - コンピュータ: ランダムに選択

2. カード予想
   - 人間プレイヤー: ダイアログで選択
   - コンピュータ: ランダムに予想

3. 結果判定
   - 正解: 相手のカードを表向きに
   - 不正解: 自分のカードを表向きに

### 勝利条件
- 最後まで裏向きのカードを持っているプレイヤーが勝利
- 全プレイヤーのカードが表向きになった場合は引き分け 